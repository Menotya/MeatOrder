<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ó–∞–∫–∞–∑ –º—è—Å–∞</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
* { box-sizing: border-box; }
body {
  margin: 0; font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
  background: #f4f6f8; color: #1a1a1a;
  -webkit-tap-highlight-color: transparent;
}
.container {
  max-width: 480px; margin: auto; padding: 16px; min-height: 100vh;
}
.card {
  background: #fff; border-radius: 18px; padding: 20px;
  margin-bottom: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  transition: transform 0.2s ease;
}
.card:hover { transform: translateY(-2px); }
h1, h2 { text-align: center; margin-top: 0; color: #1a1a1a; }
h3 { margin: 20px 0 12px; color: #333; }
input, button, .date-selector, textarea {
  width: 100%; padding: 15px; margin-top: 12px;
  border-radius: 12px; border: 2px solid #e1e5e9; font-size: 16px;
  font-family: inherit; transition: all 0.2s;
}
input:focus, .date-selector:focus, textarea:focus {
  outline: none; border-color: #2ea6ff; box-shadow: 0 0 0 3px rgba(46, 166, 255, 0.15);
}
input.invalid { border-color: #ff3b30; }
input.valid { border-color: #4cd964; }
button {
  background: linear-gradient(135deg, #2ea6ff, #1d8fe3); color: #fff;
  border: none; font-weight: 600; cursor: pointer; user-select: none;
  margin-top: 16px; min-height: 50px;
}
button:active { transform: scale(0.98); }
button.secondary { background: #f1f3f5; color: #2c3e50; }
button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –¥–∞—Ç—ã */
.date-selector {
  background: white; cursor: pointer; display: flex; align-items: center;
  justify-content: space-between; padding-right: 12px;
}
.date-selector span { color: #666; }
.date-selector .date-value { color: #1a1a1a; font-weight: 500; }
.calendar-icon { font-size: 20px; color: #2ea6ff; }

/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
.calendar-popup {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 2000; display: flex;
  align-items: center; justify-content: center; padding: 20px;
}
.calendar-container {
  background: white; border-radius: 20px; padding: 25px;
  max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.calendar-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;
}
.calendar-header button {
  width: 40px; height: 40px; margin: 0; border-radius: 50%;
  background: #f1f3f5; color: #333; font-size: 18px;
}
.calendar-grid {
  display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
}
.calendar-day {
  text-align: center; padding: 10px 0; font-weight: 500; color: #666;
}
.calendar-date {
  aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; cursor: pointer; transition: all 0.2s; font-weight: 500;
}
.calendar-date:hover { background: #f1f3f5; }
.calendar-date.selected {
  background: linear-gradient(135deg, #2ea6ff, #1d8fe3); color: white;
}
.calendar-date.disabled {
  color: #ccc; cursor: not-allowed; background: none;
}
.calendar-today { border: 2px solid #2ea6ff; }

.tabs {
  display: flex; gap: 10px; margin-bottom: 20px; background: #f1f3f5;
  padding: 6px; border-radius: 14px;
}
.tabs button {
  flex: 1; background: transparent; color: #666; margin: 0; padding: 14px;
  border-radius: 10px; border: none; font-weight: 500; min-height: auto;
}
.tabs .active {
  background: #fff; color: #2ea6ff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* –£–õ–£–ß–®–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –¢–û–í–ê–†–û–í */
.product {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 0; border-bottom: 1px solid #f0f0f0;
  gap: 15px;
}
.product:last-child { border-bottom: none; }
.product-info { 
  flex: 1; min-width: 0; /* –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Ç–µ–∫—Å—Ç–∞ */
}
.product-name { 
  font-weight: 700; color: #1a1a1a; font-size: 17px;
  margin-bottom: 4px; line-height: 1.3;
}
.product-price { 
  color: #2ea6ff; font-weight: 600; font-size: 15px;
  display: flex; align-items: center; gap: 4px;
}
.product-price-amount { font-weight: 700; }
.product-controls {
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0;
}
.quantity-controls {
  display: flex; align-items: center; gap: 10px;
  background: #f8f9fa; padding: 6px; border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.quantity-btn {
  width: 36px; height: 36px; border-radius: 10px;
  background: white; border: 2px solid #e1e5e9; 
  font-size: 18px; font-weight: 600; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; color: #333;
}
.quantity-btn:hover {
  background: #f0f9ff; border-color: #2ea6ff;
  transform: translateY(-1px);
}
.quantity-btn:active {
  transform: translateY(0) scale(0.95);
}
.quantity-btn.minus { color: #ff3b30; }
.quantity-btn.plus { color: #2ea6ff; }
.quantity-display {
  min-width: 50px; text-align: center; font-weight: 700;
  font-size: 17px; color: #1a1a1a;
}
.kg-label {
  font-size: 13px; color: #666; margin-left: 2px;
  font-weight: 500;
}

.total {
  font-size: 22px; font-weight: 700; text-align: right; margin-top: 24px;
  padding-top: 20px; border-top: 2px dashed #e1e5e9; color: #1a1a1a;
}
.total small { font-size: 14px; color: #666; font-weight: normal; display: block; }

.hidden { display: none !important; }

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7); z-index: 1000;
  display: flex; align-items: center; justify-content: center;
  padding: 20px; animation: fadeIn 0.3s ease;
}
.modal {
  background: #fff; border-radius: 24px; padding: 30px;
  width: 100%; max-width: 440px; max-height: 85vh;
  overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
.modal h2 { margin-top: 0; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ */
.address-container { position: relative; }
.autocomplete {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;
  background: #fff; border: 2px solid #2ea6ff; border-top: none;
  border-radius: 0 0 12px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  max-height: 300px; overflow-y: auto; margin-top: -2px;
}
.autocomplete-item {
  padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f1f3f5;
  transition: background 0.2s; color: #333; font-size: 14px;
}
.autocomplete-item:hover, .autocomplete-item.selected { background: #f0f9ff; }
.autocomplete-item b { color: #2ea6ff; }
.autocomplete-empty { padding: 20px; text-align: center; color: #999; }
.address-details { 
  display: block; margin-top: 4px; color: #666; font-size: 12px;
  line-height: 1.3;
}

/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
.notification {
  position: fixed; top: 20px; right: 20px; background: #4cd964;
  color: white; padding: 15px 25px; border-radius: 12px;
  box-shadow: 0 10px 25px rgba(76, 217, 100, 0.3); z-index: 2000;
  animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
  max-width: 320px;
}
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeOut { to { opacity: 0; } }

/* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
.comment-container { margin-top: 20px; }
.comment-label { 
  display: block; margin-bottom: 8px; font-weight: 500; color: #333;
}
.comment-counter {
  text-align: right; font-size: 12px; color: #666; margin-top: 4px;
}
textarea {
  min-height: 100px; resize: vertical;
  font-family: inherit; line-height: 1.4;
}
</style>
</head>

<body>
<div class="container">
  <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
  <div class="card" id="regBlock">
    <h1>–ó–∞–∫–∞–∑ –º—è—Å–∞ ü•©</h1>
    <p style="text-align:center;color:#666;margin-bottom:24px;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏</p>
    
    <input id="firstName" placeholder="–ò–º—è *" required>
    
    <input id="lastName" placeholder="–§–∞–º–∏–ª–∏—è">
    
    <div>
      <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω *" type="tel" required
             pattern="^(\+7|7|8)?[\s\-]?\(?[0-9]{3}\)?[\s\-]?[0-9]{3}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}$">
      <div style="font-size:12px;color:#666;margin-top:4px;">–ü—Ä–∏–º–µ—Ä: +7 (911) 123-45-67 –∏–ª–∏ 89111234567</div>
    </div>
    
    <button onclick="validateAndOpenShop()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
    <p style="font-size:14px;color:#999;text-align:center;margin-top:20px;">* –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</p>
  </div>

  <!-- –ú–ê–ì–ê–ó–ò–ù -->
  <div class="card hidden" id="shopBlock">
    <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
    <p style="text-align:center;color:#666;margin-bottom:20px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º—è—Å–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</p>

    <div class="tabs">
      <button id="tabHalal" onclick="switchTab('halal')">ü•© –•–∞–ª—è–ª—å</button>
      <button id="tabNormal" onclick="switchTab('normal')">üçó –û–±—ã—á–Ω–æ–µ</button>
    </div>

    <div id="products"></div>

    <h3>üì¶ –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
    <div class="address-container">
      <input id="address" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —É–ª–∏—Ü—É, –¥–æ–º..." autocomplete="off">
      <div id="addressList" class="autocomplete hidden"></div>
    </div>
    <p style="font-size:14px;color:#666;margin-top:8px;">–í–≤–µ–¥–∏—Ç–µ —É–ª–∏—Ü—É –∏ –Ω–æ–º–µ—Ä –¥–æ–º–∞ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ</p>

    <h3>üìÖ –î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
    <div class="date-selector" onclick="openCalendar()">
      <span class="date-value" id="selectedDate">–ó–∞–≤—Ç—Ä–∞</span>
      <span class="calendar-icon">üìÖ</span>
    </div>
    <p style="font-size:14px;color:#666;margin-top:8px;">–î–æ—Å—Ç—É–ø–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π</p>

    <div class="comment-container">
      <label class="comment-label">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ –¥–æ—Å—Ç–∞–≤–∫–∏, –∫–æ–¥ –¥–æ–º–æ—Ñ–æ–Ω–∞ –∏ —Ç.–¥." 
                maxlength="500" oninput="updateCommentCounter()"></textarea>
      <div class="comment-counter" id="commentCounter">0/500 —Å–∏–º–≤–æ–ª–æ–≤</div>
    </div>

    <div class="total">
      <small>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞</small>
      <span id="total">0</span> ‚ÇΩ
    </div>
    <button onclick="openReceiptModal()">‚úÖ –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ</button>
    <button class="secondary" onclick="backToRegistration()">‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∞–Ω–Ω—ã–º</button>
  </div>
</div>

<!-- –ö–ê–õ–ï–ù–î–ê–†–¨ –î–õ–Ø –í–´–ë–û–†–ê –î–ê–¢–´ -->
<div id="calendarPopup" class="calendar-popup hidden">
  <div class="calendar-container">
    <div class="calendar-header">
      <button onclick="changeMonth(-1)">‚Üê</button>
      <h3 id="calendarMonth">–î–µ–∫–∞–±—Ä—å 2024</h3>
      <button onclick="changeMonth(1)">‚Üí</button>
    </div>
    <div class="calendar-grid" id="calendarGrid">
      <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è -->
    </div>
    <button style="margin-top: 20px;" onclick="closeCalendar()">–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É</button>
  </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ß–ï–ö–ê -->
<div id="receiptModal" class="modal-overlay hidden">
  <div class="modal">
    <h2>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–∫–∞–∑ ‚úÖ</h2>
    <div id="receiptContent"></div>
    <button onclick="sendOrder()">üì¶ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <button class="secondary" onclick="closeReceiptModal()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–∞–≤–∫–∞–º</button>
  </div>
</div>

<!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï -->
<div id="notification" class="hidden"></div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.enableClosingConfirmation();

/* === –í–ê–® API –ö–õ–Æ–ß DaData === */
const DADATA_API_KEY = 'f1cd666f93981947f9e2ebe272204c2ef12b6710';

/* === –ü–†–û–î–£–ö–¢–´ (—Ü–µ–Ω–∞ –∑–∞ 1 –∫–≥) === */
const halalProducts = [
  {id:1, name:"–ö—Ä—ã–ª—å—è —Ö–∞–ª—è–ª—å", price:280, emoji:"üçó"},
  {id:2, name:"–ë–µ–¥—Ä–∞ —Ö–∞–ª—è–ª—å", price:300, emoji:"üçñ"},
  {id:3, name:"–§–∏–ª–µ —Ö–∞–ª—è–ª—å", price:360, emoji:"ü•©"},
  {id:4, name:"–ì–æ–ª–µ–Ω—å —Ö–∞–ª—è–ª—å", price:290, emoji:"ü¶µ"},
  {id:5, name:"–§–∞—Ä—à —Ö–∞–ª—è–ª—å", price:320, emoji:"ü•ò"},
  {id:6, name:"–¢—É—à–∫–∞ —Ö–∞–ª—è–ª—å", price:250, emoji:"üêî"}
];
const normalProducts = [
  {id:7, name:"–ö—Ä—ã–ª—å—è", price:240, emoji:"üçó"},
  {id:8, name:"–ë–µ–¥—Ä–∞", price:260, emoji:"üçñ"},
  {id:9, name:"–§–∏–ª–µ", price:330, emoji:"ü•©"},
  {id:10, name:"–ì–æ–ª–µ–Ω—å", price:255, emoji:"ü¶µ"},
  {id:11, name:"–§–∞—Ä—à", price:290, emoji:"ü•ò"},
  {id:12, name:"–¢—É—à–∫–∞", price:220, emoji:"üêî"}
];

let currentTab = "halal";
const cart = [];
let addressTimeout = null;

/* === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–õ–ò–ß–ï–°–¢–í–û–ú –¢–û–í–ê–†–û–í === */
function changeQuantity(productId, delta) {
  const productList = currentTab === "halal" ? halalProducts : normalProducts;
  const product = productList.find(p => p.id === productId);
  
  const index = cart.findIndex(item => item.id === productId);
  let currentKg = 0;
  
  if (index !== -1) {
    currentKg = cart[index].kg;
  }
  
  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º/—É–º–µ–Ω—å—à–∞–µ–º –Ω–∞ 5 –∫–≥
  let newKg = Math.max(0, currentKg + delta);
  
  // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –∫—Ä–∞—Ç–Ω–æ–≥–æ 5
  newKg = Math.round(newKg / 5) * 5;
  
  if (newKg > 0) {
    if (index !== -1) {
      cart[index].kg = newKg;
    } else {
      cart.push({
        ...product,
        kg: newKg,
        type: currentTab
      });
    }
  } else if (index !== -1) {
    cart.splice(index, 1);
  }
  
  renderProducts();
  calcTotal();
}

function renderProducts() {
  const productsContainer = document.getElementById('products');
  const list = currentTab === "halal" ? halalProducts : normalProducts;
  
  productsContainer.innerHTML = list.map(product => {
    const existing = cart.find(item => item.id === product.id);
    const quantity = existing ? existing.kg : 0;
    
    return `
      <div class="product">
        <div class="product-info">
          <div class="product-name">${product.emoji} ${product.name}</div>
          <div class="product-price">
            <span class="product-price-amount">${product.price}</span> ‚ÇΩ / –∫–≥
          </div>
        </div>
        <div class="product-controls">
          <div class="quantity-controls">
            <button class="quantity-btn minus" onclick="changeQuantity(${product.id}, -5)">‚àí</button>
            <div class="quantity-display">
              ${quantity}<span class="kg-label">–∫–≥</span>
            </div>
            <button class="quantity-btn plus" onclick="changeQuantity(${product.id}, 5)">+</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function calcTotal() {
  let sum = 0;
  cart.forEach(item => {
    if (item.kg > 0) sum += item.kg * item.price;
  });
  document.getElementById('total').textContent = sum.toLocaleString('ru-RU');
}

/* === –ö–ê–õ–ï–ù–î–ê–†–¨ –î–õ–Ø –í–´–ë–û–†–ê –î–ê–¢–´ === */
let currentCalendarDate = new Date();
currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
const today = new Date();
const maxDate = new Date();
maxDate.setDate(today.getDate() + 7);

function formatDate(date) {
  const options = { weekday: 'long', day: 'numeric', month: 'long' };
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  
  if (date.toDateString() === today.toDateString()) return '–°–µ–≥–æ–¥–Ω—è';
  if (date.toDateString() === tomorrow.toDateString()) return '–ó–∞–≤—Ç—Ä–∞';
  
  return date.toLocaleDateString('ru-RU', options);
}

function updateSelectedDateDisplay() {
  document.getElementById('selectedDate').textContent = formatDate(currentCalendarDate);
}

function openCalendar() {
  renderCalendar();
  document.getElementById('calendarPopup').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeCalendar() {
  document.getElementById('calendarPopup').classList.add('hidden');
  document.body.style.overflow = 'auto';
  updateSelectedDateDisplay();
}

function changeMonth(delta) {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
  renderCalendar();
}

function renderCalendar() {
  const year = currentCalendarDate.getFullYear();
  const month = currentCalendarDate.getMonth();
  
  const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                     '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
  document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  
  const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
  let calendarHTML = '';
  
  dayNames.forEach(day => {
    calendarHTML += `<div class="calendar-day">${day}</div>`;
  });
  
  const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
  for (let i = 0; i < startDay; i++) {
    calendarHTML += `<div class="calendar-date"></div>`;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const isToday = date.toDateString() === today.toDateString();
    const isSelected = date.toDateString() === currentCalendarDate.toDateString();
    const isDisabled = date < today || date > maxDate;
    
    let className = 'calendar-date';
    if (isToday) className += ' calendar-today';
    if (isSelected) className += ' selected';
    if (isDisabled) className += ' disabled';
    
    calendarHTML += `
      <div class="${className}" 
           ${!isDisabled ? `onclick="selectDate(${year}, ${month}, ${day})"` : ''}>
        ${day}
      </div>
    `;
  }
  
  document.getElementById('calendarGrid').innerHTML = calendarHTML;
}

function selectDate(year, month, day) {
  currentCalendarDate = new Date(year, month, day);
  closeCalendar();
}

/* === –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï –ê–î–†–ï–°–ê –° –í–ê–®–ò–ú API –ö–õ–Æ–ß–û–ú === */
const addressInput = document.getElementById('address');
const addressList = document.getElementById('addressList');

addressInput.addEventListener('input', function() {
  clearTimeout(addressTimeout);
  const query = this.value.trim();
  
  if (query.length < 2) {
    addressList.classList.add('hidden');
    return;
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  addressList.innerHTML = '<div class="autocomplete-item">–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤...</div>';
  addressList.classList.remove('hidden');
  
  addressTimeout = setTimeout(() => searchAddresses(query), 300);
});

async function searchAddresses(query) {
  try {
    const url = `https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address`;
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Authorization': `Token ${DADATA_API_KEY}`
      },
      body: JSON.stringify({
        query: query,
        count: 7,
        locations: [{ 
          city: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥'
        }],
        from_bound: { value: "street" },
        to_bound: { value: "house" },
        restrict_value: true,
        language: "ru"
      })
    });
    
    if (!response.ok) {
      console.error('–û—à–∏–±–∫–∞ DaData:', await response.text());
      throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ DaData');
    }
    
    const data = await response.json();
    
    if (!data.suggestions || data.suggestions.length === 0) {
      addressList.innerHTML = '<div class="autocomplete-empty">–ê–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –£—Ç–æ—á–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å</div>';
      return;
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤
    addressList.innerHTML = data.suggestions.map(item => {
      const data = item.data;
      let mainText = '';
      let details = '';
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç: —É–ª–∏—Ü–∞ –∏ –¥–æ–º
      if (data.street) {
        mainText = data.street;
        if (data.house) {
          mainText += `, ${data.house}`;
        }
      } else if (data.house) {
        mainText = data.house;
      } else {
        mainText = item.value;
      }
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏: –∫–æ—Ä–ø—É—Å, —Å—Ç—Ä–æ–µ–Ω–∏–µ
      const detailsParts = [];
      if (data.block_type && data.block) {
        detailsParts.push(`${data.block_type} ${data.block}`);
      }
      if (data.house_type && data.house) {
        detailsParts.push(data.house_type);
      }
      
      details = detailsParts.join(', ');
      
      return `
        <div class="autocomplete-item" data-address="${item.value}">
          <b>${mainText}</b>
          ${details ? `<span class="address-details">${details}</span>` : ''}
        </div>
      `;
    }).join('');
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
    addressList.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', function() {
        addressInput.value = this.getAttribute('data-address');
        addressList.classList.add('hidden');
        showNotification('–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω', 'success');
      });
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–∞:', error);
    addressList.innerHTML = '<div class="autocomplete-empty">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç</div>';
  }
}

// –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', function(e) {
  if (!addressInput.contains(e.target) && !addressList.contains(e.target)) {
    addressList.classList.add('hidden');
  }
});

/* === –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô === */
function updateCommentCounter() {
  const comment = document.getElementById('comment');
  const counter = document.getElementById('commentCounter');
  const length = comment.value.length;
  counter.textContent = `${length}/500 —Å–∏–º–≤–æ–ª–æ–≤`;
  
  if (length > 450) {
    counter.style.color = '#ff3b30';
  } else if (length > 400) {
    counter.style.color = '#ff9500';
  } else {
    counter.style.color = '#666';
  }
}

/* === –í–ê–õ–ò–î–ê–¶–ò–Ø –¢–ï–õ–ï–§–û–ù–ê === */
function validatePhone(phone) {
  const cleanPhone = phone.replace(/\D/g, '');
  
  if (cleanPhone.length < 10) return false;
  
  const validStarts = ['79', '89', '7', '8', '9'];
  const startsCorrect = validStarts.some(start => cleanPhone.startsWith(start));
  
  if (!startsCorrect) return false;
  
  let phoneDigits = cleanPhone;
  if (phoneDigits.length === 11 && phoneDigits.startsWith('7')) {
    phoneDigits = phoneDigits.substring(1);
  } else if (phoneDigits.length === 11 && phoneDigits.startsWith('8')) {
    phoneDigits = phoneDigits.substring(1);
  }
  
  return phoneDigits.length === 10;
}

function formatPhone(phone) {
  const cleanPhone = phone.replace(/\D/g, '');
  if (cleanPhone.length === 10) {
    return '+7 (' + cleanPhone.substring(0, 3) + ') ' + 
           cleanPhone.substring(3, 6) + '-' + 
           cleanPhone.substring(6, 8) + '-' + 
           cleanPhone.substring(8, 10);
  }
  if (cleanPhone.length === 11 && cleanPhone.startsWith('7')) {
    return '+7 (' + cleanPhone.substring(1, 4) + ') ' + 
           cleanPhone.substring(4, 7) + '-' + 
           cleanPhone.substring(7, 9) + '-' + 
           cleanPhone.substring(9, 11);
  }
  if (cleanPhone.length === 11 && cleanPhone.startsWith('8')) {
    return '+7 (' + cleanPhone.substring(1, 4) + ') ' + 
           cleanPhone.substring(4, 7) + '-' + 
           cleanPhone.substring(7, 9) + '-' + 
           cleanPhone.substring(9, 11);
  }
  return phone;
}

/* === –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø === */
function validateAndOpenShop() {
  const firstName = document.getElementById('firstName');
  const phone = document.getElementById('phone');
  
  firstName.classList.remove('invalid', 'valid');
  phone.classList.remove('invalid', 'valid');
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏
  if (!firstName.value.trim()) {
    firstName.classList.add('invalid');
    showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º—è', 'error');
    return;
  } else {
    firstName.classList.add('valid');
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  const phoneValue = phone.value.trim();
  if (!phoneValue) {
    phone.classList.add('invalid');
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
    return;
  }
  
  if (!validatePhone(phoneValue)) {
    phone.classList.add('invalid');
    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
    return;
  } else {
    phone.classList.add('valid');
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
  window.userData = {
    firstName: firstName.value.trim(),
    lastName: document.getElementById('lastName').value.trim(),
    phone: formatPhone(phoneValue)
  };
  
  openShop();
}

function openShop() {
  document.getElementById('regBlock').classList.add('hidden');
  document.getElementById('shopBlock').classList.remove('hidden');
  switchTab('halal');
  showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã', 'success');
  updateSelectedDateDisplay();
  updateCommentCounter();
}

function switchTab(tab) {
  currentTab = tab;
  const tabHalal = document.getElementById('tabHalal');
  const tabNormal = document.getElementById('tabNormal');
  
  tabHalal.classList.toggle('active', tab === "halal");
  tabNormal.classList.toggle('active', tab === "normal");
  
  renderProducts();
}

/* === –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê === */
function openReceiptModal() {
  const address = addressInput.value.trim();
  
  if (!address) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏', 'error');
    addressInput.focus();
    return;
  }
  
  const activeCart = cart.filter(item => item.kg > 0);
  if (activeCart.length === 0) {
    showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É', 'error');
    return;
  }
  
  const receiptContent = document.getElementById('receiptContent');
  let html = `
    <div style="margin-bottom:20px;">
      <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${window.userData.firstName} ${window.userData.lastName}</p>
      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${window.userData.phone}</p>
      <p><strong>–ê–¥—Ä–µ—Å:</strong> ${address}</p>
      <p><strong>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> ${formatDate(currentCalendarDate)}</p>
  `;
  
  const comment = document.getElementById('comment').value.trim();
  if (comment) {
    html += `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${comment}</p>`;
  }
  
  html += `</div>
    <hr style="border:none;border-top:1px solid #eee;margin:20px 0;">
    <div style="max-height:300px;overflow-y:auto;">
      <h4 style="margin-top:0;">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</h4>
  `;
  
  activeCart.forEach(item => {
    html += `
      <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f5f5f5;">
        <div>
          <strong>${item.name}</strong><br>
          <small>${item.type === 'halal' ? 'ü•© –•–∞–ª—è–ª—å' : 'üçó –û–±—ã—á–Ω–æ–µ'}</small>
        </div>
        <div style="text-align:right;">
          ${item.kg} –∫–≥ √ó ${item.price} ‚ÇΩ<br>
          <strong>${(item.kg * item.price).toLocaleString('ru-RU')} ‚ÇΩ</strong>
        </div>
      </div>
    `;
  });
  
  html += `
    </div>
    <hr style="border:none;border-top:1px solid #eee;margin:20px 0;">
    <div style="text-align:right;font-size:24px;font-weight:bold;color:#2ea6ff;">
      –ò—Ç–æ–≥–æ: ${document.getElementById('total').textContent} ‚ÇΩ
    </div>
  `;
  
  receiptContent.innerHTML = html;
  document.getElementById('receiptModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeReceiptModal() {
  document.getElementById('receiptModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function sendOrder() {
    const orderData = {
        user: window.userData,
        cart: cart.filter(item => item.kg > 0),
        address: addressInput.value.trim(),
        date: currentCalendarDate.toISOString().split('T')[0],
        dateFormatted: formatDate(currentCalendarDate),
        comment: document.getElementById('comment').value.trim(),
        total: document.getElementById('total').textContent.replace(/\s/g, '') // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –¥–ª—è —á–∏—Å–ª–∞
    };
    
    console.log('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:', orderData);
    
    // –í–ê–ñ–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Telegram WebApp ‚Üê –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢!
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.sendData(JSON.stringify(orderData));
    } else {
        console.error('Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞', 'error');
        return;
    }
    
    showNotification('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!', 'success');
    
    setTimeout(() => {
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.close();
        }
    }, 2000);
}

function backToRegistration() {
  document.getElementById('shopBlock').classList.add('hidden');
  document.getElementById('regBlock').classList.remove('hidden');
}

function showNotification(message, type = 'info') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = 'notification';
  notification.style.background = type === 'error' ? '#ff3b30' : 
                                 type === 'success' ? '#4cd964' : '#2ea6ff';
  notification.classList.remove('hidden');
  
  setTimeout(() => {
    notification.classList.add('hidden');
  }, 3000);
}

/* === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø === */
document.addEventListener('DOMContentLoaded', function() {
  if (localStorage.getItem('meatShopUserData')) {
    try {
      const savedData = JSON.parse(localStorage.getItem('meatShopUserData'));
      document.getElementById('firstName').value = savedData.firstName || '';
      document.getElementById('lastName').value = savedData.lastName || '';
      document.getElementById('phone').value = savedData.phone || '';
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e);
    }
  }
  
  ['firstName', 'lastName', 'phone'].forEach(id => {
    document.getElementById(id).addEventListener('blur', function() {
      const userData = {
        firstName: document.getElementById('firstName').value,
        lastName: document.getElementById('lastName').value,
        phone: document.getElementById('phone').value
      };
      localStorage.setItem('meatShopUserData', JSON.stringify(userData));
    });
  });
  
  // –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  document.getElementById('phone').addEventListener('blur', function() {
    if (validatePhone(this.value)) {
      this.value = formatPhone(this.value);
      this.classList.add('valid');
      this.classList.remove('invalid');
    }
  });
  
  calcTotal();
  updateSelectedDateDisplay();
  renderProducts();
  updateCommentCounter();
});
  async function sendToBot(orderData) {
    try {
        // –ü—Ä—è–º–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram WebApp
        tg.sendData(JSON.stringify(orderData));
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä –¥–ª—è –±—ç–∫–∞–ø–∞
        const response = await fetch('YOUR_BOT_WEBHOOK_URL', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
        });
        
        return true;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
        return false;
    }
}
</script>
</body>
</html>
