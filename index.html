<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ó–∞–∫–∞–∑ –º—è—Å–∞</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
* { box-sizing: border-box; }
body {
  margin: 0; font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
  background: #f4f6f8; color: #1a1a1a;
  -webkit-tap-highlight-color: transparent;
}
.container {
  max-width: 480px; margin: auto; padding: 16px; min-height: 100vh;
}
.card {
  background: #fff; border-radius: 18px; padding: 20px;
  margin-bottom: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  transition: transform 0.2s ease;
}
.card:hover { transform: translateY(-2px); }
h1, h2 { text-align: center; margin-top: 0; color: #1a1a1a; }
h3 { margin: 20px 0 12px; color: #333; }
input, button, .date-selector, textarea, select {
  width: 100%; padding: 15px; margin-top: 12px;
  border-radius: 12px; border: 2px solid #e1e5e9; font-size: 16px;
  font-family: inherit; transition: all 0.2s;
}
input:focus, .date-selector:focus, textarea:focus, select:focus {
  outline: none; border-color: #2ea6ff; box-shadow: 0 0 0 3px rgba(46, 166, 255, 0.15);
}
input.invalid, select.invalid { border-color: #ff3b30; }
input.valid, select.valid { border-color: #4cd964; }
button {
  background: linear-gradient(135deg, #2ea6ff, #1d8fe3); color: #fff;
  border: none; font-weight: 600; cursor: pointer; user-select: none;
  margin-top: 16px; min-height: 50px;
}
button:active { transform: scale(0.98); }
button.secondary { background: #f1f3f5; color: #2c3e50; }
button.repeat-order { 
  background: linear-gradient(135deg, #4cd964, #34c759); 
  margin-bottom: 10px;
}
button:disabled { background: #ccc; cursor: not-allowed; transform: none; }

/* –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è */
.required-field {
  position: relative;
}
.required-field::after {
  content: '*';
  color: #ff3b30;
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  font-weight: bold;
}

/* –ö—Ä–µ—Å—Ç–∏–∫ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞ */
.address-container {
  position: relative;
}
.clear-address {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  font-size: 20px;
  color: #999;
  cursor: pointer;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  margin: 0;
  z-index: 10;
}
.clear-address:hover {
  color: #ff3b30;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –¥–∞—Ç—ã */
.date-selector {
  background: white; cursor: pointer; display: flex; align-items: center;
  justify-content: space-between; padding-right: 12px;
}
.date-selector span { color: #666; }
.date-selector .date-value { color: #1a1a1a; font-weight: 500; }
.calendar-icon { font-size: 20px; color: #2ea6ff; }

/* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
.calendar-popup {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 2000; display: flex;
  align-items: center; justify-content: center; padding: 20px;
}
.calendar-container {
  background: white; border-radius: 20px; padding: 25px;
  max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.calendar-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;
}
.calendar-header button {
  width: 40px; height: 40px; margin: 0; border-radius: 50%;
  background: #f1f3f5; color: #333; font-size: 18px;
}
.calendar-grid {
  display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
}
.calendar-day {
  text-align: center; padding: 10px 0; font-weight: 500; color: #666;
}
.calendar-date {
  aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; cursor: pointer; transition: all 0.2s; font-weight: 500;
}
.calendar-date:hover { background: #f1f3f5; }
.calendar-date.selected {
  background: linear-gradient(135deg, #2ea6ff, #1d8fe3); color: white;
}
.calendar-date.disabled {
  color: #ccc; cursor: not-allowed; background: none;
}
.calendar-today { border: 2px solid #2ea6ff; }

.tabs {
  display: flex; gap: 10px; margin-bottom: 20px; background: #f1f3f5;
  padding: 6px; border-radius: 14px;
}
.tabs button {
  flex: 1; background: transparent; color: #666; margin: 0; padding: 14px;
  border-radius: 10px; border: none; font-weight: 500; min-height: auto;
}
.tabs .active {
  background: #fff; color: #2ea6ff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* –î–í–ê –°–¢–û–õ–ë–¶–ê –î–õ–Ø –¢–û–í–ê–†–û–í */
.products-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}
.product-card {
  background: #fff;
  border-radius: 14px;
  padding: 15px;
  border: 2px solid #e1e5e9;
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
}
.product-card:hover {
  border-color: #2ea6ff;
  box-shadow: 0 6px 12px rgba(46, 166, 255, 0.1);
}
.product-header {
  display: flex;
  align-items: center;
  margin-bottom: 12px;
}
.product-emoji {
  font-size: 24px;
  margin-right: 10px;
}
.product-name {
  font-weight: 700;
  color: #1a1a1a;
  font-size: 15px;
  line-height: 1.3;
  flex: 1;
}
.product-price {
  color: #2ea6ff;
  font-weight: 600;
  font-size: 14px;
  text-align: center;
  margin-bottom: 12px;
}
.product-controls {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}
.quantity-display {
  font-size: 20px;
  font-weight: 700;
  color: #1a1a1a;
  text-align: center;
}
.kg-label {
  font-size: 12px;
  color: #666;
  margin-left: 2px;
}
.quantity-buttons {
  display: flex;
  gap: 10px;
  width: 100%;
}
.quantity-btn {
  flex: 1;
  height: 36px;
  border-radius: 10px;
  background: #f8f9fa;
  border: 2px solid #e1e5e9;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.quantity-btn:hover {
  background: #f0f9ff;
  border-color: #2ea6ff;
}
.quantity-btn:active {
  transform: scale(0.95);
}
.quantity-btn.minus { color: #ff3b30; }
.quantity-btn.plus { color: #2ea6ff; }

/* –¶–ï–ù–´ –î–õ–Ø –û–ü–õ–ê–¢–´ */
.payment-note {
  background: #fff8e6;
  border: 2px solid #ffd700;
  border-radius: 12px;
  padding: 12px 15px;
  margin: 15px 0;
  font-size: 14px;
  color: #666;
}
.payment-note strong {
  color: #ff9500;
}

.total {
  font-size: 22px; font-weight: 700; text-align: right; margin-top: 24px;
  padding-top: 20px; border-top: 2px dashed #e1e5e9; color: #1a1a1a;
}
.total small { font-size: 14px; color: #666; font-weight: normal; display: block; }

.hidden { display: none !important; }

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7); z-index: 1000;
  display: flex; align-items: center; justify-content: center;
  padding: 20px; animation: fadeIn 0.3s ease;
}
.modal {
  background: #fff; border-radius: 24px; padding: 30px;
  width: 100%; max-width: 440px; max-height: 85vh;
  overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
.modal h2 { margin-top: 0; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ */
.autocomplete {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 1000;
  background: #fff; border: 2px solid #2ea6ff; border-top: none;
  border-radius: 0 0 12px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  max-height: 300px; overflow-y: auto; margin-top: -2px;
}
.autocomplete-item {
  padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f1f3f5;
  transition: background 0.2s; color: #333; font-size: 14px;
}
.autocomplete-item:hover, .autocomplete-item.selected { background: #f0f9ff; }
.autocomplete-item b { color: #2ea6ff; }
.autocomplete-empty { padding: 20px; text-align: center; color: #999; }
.address-details { 
  display: block; margin-top: 4px; color: #666; font-size: 12px;
  line-height: 1.3;
}

/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
.notification {
  position: fixed; top: 20px; right: 20px; background: #4cd964;
  color: white; padding: 15px 25px; border-radius: 12px;
  box-shadow: 0 10px 25px rgba(76, 217, 100, 0.3); z-index: 2000;
  animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
  max-width: 320px;
}
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeOut { to { opacity: 0; } }

/* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
.comment-container { margin-top: 20px; }
.comment-label { 
  display: block; margin-bottom: 8px; font-weight: 500; color: #333;
}
.comment-counter {
  text-align: right; font-size: 12px; color: #666; margin-top: 4px;
}
textarea {
  min-height: 100px; resize: vertical;
  font-family: inherit; line-height: 1.4;
}

/* –¢–∏–ø –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ */
.organization-type {
  margin-top: 20px;
}
.organization-type label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #333;
}

/* –ü–æ–¥–ø–∏—Å–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π */
.field-label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #333;
}
.field-label.required::after {
  content: '*';
  color: #ff3b30;
  margin-left: 3px;
}

/* –ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞ */
.address-match {
  font-size: 11px;
  color: #4cd964;
  margin-top: 2px;
  display: block;
}
</style>
</head>

<body>
<div class="container">
  <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
  <div class="card" id="regBlock">
    <h1>–ó–∞–∫–∞–∑ –º—è—Å–∞ ü•©</h1>
    <p style="text-align:center;color:#666;margin-bottom:24px;">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏</p>
    
    <div>
      <label class="field-label required">–ò–º—è</label>
      <input id="firstName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" required class="required-field">
    </div>
    
    <div>
      <label class="field-label">–§–∞–º–∏–ª–∏—è</label>
      <input id="lastName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é">
    </div>
    
    <div>
      <label class="field-label required">–¢–µ–ª–µ—Ñ–æ–Ω</label>
      <input id="phone" placeholder="+7 (___) ___-__-__" type="tel" required class="required-field">
      <div style="font-size:12px;color:#666;margin-top:4px;">–ü—Ä–∏–º–µ—Ä: +7 (911) 123-45-67</div>
    </div>
    
    <div>
      <label class="field-label required">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞/—Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</label>
      <input id="organizationName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–µ—Å—Ç–æ—Ä–∞–Ω '–£ –ü–µ—Ç—Ä–æ–≤–∏—á–∞'" required class="required-field">
    </div>
    
    <button onclick="validateAndOpenShop()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
    <p style="font-size:14px;color:#999;text-align:center;margin-top:20px;">
      <span style="color:#ff3b30;">*</span> –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—è
    </p>
  </div>

  <!-- –ú–ê–ì–ê–ó–ò–ù -->
  <div class="card hidden" id="shopBlock">
    <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
    <p style="text-align:center;color:#666;margin-bottom:20px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –º—è—Å–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</p>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–≤—Ç–æ—Ä–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞ -->
    <button class="repeat-order" onclick="repeatLastOrder()" id="repeatOrderBtn">
      üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–∫–∞–∑
    </button>

    <div class="tabs">
      <button id="tabHalal" onclick="switchTab('halal')">ü•© –•–∞–ª—è–ª—å</button>
      <button id="tabNormal" onclick="switchTab('normal')">üçó –û–±—ã—á–Ω–æ–µ</button>
    </div>

    <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ —Ü–µ–Ω–∞—Ö -->
    <div class="payment-note">
      üí∞ <strong>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:</strong> –¶–µ–Ω—ã —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –Ω–∞–ª–∏—á–Ω—ã–º–∏.
      –ü—Ä–∏ –±–µ–∑–Ω–∞–ª–∏—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ –∫–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è —Å—Ç–æ–∏—Ç –Ω–∞ <strong>10 —Ä—É–±–ª–µ–π –¥–æ—Ä–æ–∂–µ</strong>.
    </div>

    <div class="products-grid" id="products">
      <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
    </div>

    <h3>üì¶ –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
    <div class="address-container">
      <input id="address" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —É–ª–∏—Ü—É, –¥–æ–º..." autocomplete="off">
      <button type="button" class="clear-address hidden" id="clearAddressBtn" onclick="clearAddress()">√ó</button>
      <div id="addressList" class="autocomplete hidden"></div>
    </div>
    <p style="font-size:14px;color:#666;margin-top:8px;">–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å (—É–ª–∏—Ü–∞, –¥–æ–º). –ê–¥—Ä–µ—Å –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω.</p>

    <h3>üìÖ –î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
    <div class="date-selector" onclick="openCalendar()">
      <span class="date-value" id="selectedDate">–ó–∞–≤—Ç—Ä–∞</span>
      <span class="calendar-icon">üìÖ</span>
    </div>
    <p style="font-size:14px;color:#666;margin-top:8px;">–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é</p>

    <div class="comment-container">
      <label class="comment-label">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞ 15 –º–∏–Ω—É—Ç –¥–æ –¥–æ—Å—Ç–∞–≤–∫–∏, –∫–æ–¥ –¥–æ–º–æ—Ñ–æ–Ω–∞ –∏ —Ç.–¥." 
                maxlength="500" oninput="updateCommentCounter()"></textarea>
      <div class="comment-counter" id="commentCounter">0/500 —Å–∏–º–≤–æ–ª–æ–≤</div>
    </div>

    <div class="total">
      <small>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞ (–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –Ω–∞–ª–∏—á–Ω—ã–º–∏)</small>
      <span id="total">0</span> ‚ÇΩ
      <div id="cashlessTotal" style="font-size: 14px; color: #ff9500; margin-top: 5px;"></div>
    </div>
    <button onclick="openReceiptModal()">‚úÖ –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ</button>
    <button class="secondary" onclick="backToRegistration()">‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∞–Ω–Ω—ã–º</button>
  </div>
</div>

<!-- –ö–ê–õ–ï–ù–î–ê–†–¨ –î–õ–Ø –í–´–ë–û–†–ê –î–ê–¢–´ -->
<div id="calendarPopup" class="calendar-popup hidden">
  <div class="calendar-container">
    <div class="calendar-header">
      <button onclick="changeMonth(-1)" id="prevMonthBtn" style="visibility: hidden;">‚Üê</button>
      <h3 id="calendarMonth">–î–µ–∫–∞–±—Ä—å 2024</h3>
      <button onclick="changeMonth(1)" id="nextMonthBtn" style="visibility: hidden;">‚Üí</button>
    </div>
    <div class="calendar-grid" id="calendarGrid">
      <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è -->
    </div>
    <button style="margin-top: 20px;" onclick="closeCalendar()">–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É</button>
  </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ß–ï–ö–ê -->
<div id="receiptModal" class="modal-overlay hidden">
  <div class="modal">
    <h2>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–∫–∞–∑ ‚úÖ</h2>
    <div id="receiptContent"></div>
    <button onclick="sendOrder()">üì¶ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
    <button class="secondary" onclick="closeReceiptModal()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–∞–≤–∫–∞–º</button>
  </div>
</div>

<!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï -->
<div id="notification" class="hidden"></div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.enableClosingConfirmation();

/* === –í–ê–® API –ö–õ–Æ–ß DaData === */
const DADATA_API_KEY = 'f1cd666f93981947f9e2ebe272204c2ef12b6710';

/* === –ü–†–û–î–£–ö–¢–´ (—Ü–µ–Ω–∞ –∑–∞ 1 –∫–≥) === */
const halalProducts = [
  {id:1, name:"–¢—É—à–∫–∞", price:205, emoji:"üêî"},
  {id:2, name:"–§–∏–ª–µ –≥—Ä—É–¥–∫–∏", price:320, emoji:"üêî"},
  {id:3, name:"–§–∏–ª–µ –æ–∫–æ—Ä–æ–∫", price:295, emoji:"üêî"},
  {id:4, name:"–û–∫–æ—Ä–æ–∫ –Ω–∞ –∫–æ—Å—Ç–∏", price:180, emoji:"üêî"},
  {id:5, name:"–ë–µ–¥—Ä–æ –Ω–∞ –∫–æ—Å—Ç–∏", price:180, emoji:"üêî"},
  {id:6, name:"–ì–æ–ª–µ–Ω—å –Ω–∞ –∫–æ—Å—Ç–∏", price:180, emoji:"üêî"},
  {id:7, name:"–ö—Ä—ã–ª—å—è", price:170, emoji:"üêî"},
  {id:8, name:"–°—É–ø–æ–≤–æ–π –Ω–∞–±–æ—Ä", price:30, emoji:"üêî"},
  {id:9, name:"–§–∏–ª–µ –≥—Ä—É–¥–∫–∏ –±–µ–∑ –∫–æ–∂–∏", price:370, emoji:"üêî"},
  {id:10, name:"–û–∫–æ—Ä–æ–∫ –±–µ–∑ –∫–æ–∂–∏", price:365, emoji:"üêî"},
  {id:11, name:"–ú—è—Å–æ –¥–ª—è —à–∞–≤–µ—Ä–º—ã", price:208, emoji:"üêî"}
];
const normalProducts = [
  {id:1, name:"–¢—É—à–∫–∞", price:195, emoji:"üêî"},
  {id:2, name:"–§–∏–ª–µ –≥—Ä—É–¥–∫–∏", price:310, emoji:"üêî"},
  {id:3, name:"–§–∏–ª–µ –æ–∫–æ—Ä–æ–∫", price:285, emoji:"üêî"},
  {id:4, name:"–û–∫–æ—Ä–æ–∫ –Ω–∞ –∫–æ—Å—Ç–∏", price:170, emoji:"üêî"},
  {id:5, name:"–ë–µ–¥—Ä–æ –Ω–∞ –∫–æ—Å—Ç–∏", price:170, emoji:"üêî"},
  {id:6, name:"–ì–æ–ª–µ–Ω—å –Ω–∞ –∫–æ—Å—Ç–∏", price:170, emoji:"üêî"},
  {id:7, name:"–ö—Ä—ã–ª—å—è", price:160, emoji:"üêî"},
  {id:8, name:"–°—É–ø–æ–≤–æ–π –Ω–∞–±–æ—Ä", price:20, emoji:"üêî"},
  {id:9, name:"–§–∏–ª–µ –≥—Ä—É–¥–∫–∏ –±–µ–∑ –∫–æ–∂–∏", price:360, emoji:"üêî"},
  {id:10, name:"–û–∫–æ—Ä–æ–∫ –±–µ–∑ –∫–æ–∂–∏", price:355, emoji:"üêî"},
  {id:11, name:"–ú—è—Å–æ –¥–ª—è —à–∞–≤–µ—Ä–º—ã", price:198, emoji:"üêî"}
];

let currentTab = "halal";
const cart = [];
let addressTimeout = null;
let lastOrderData = null;
let selectedAddressData = null;

/* === –û–ß–ò–°–¢–ö–ê –ê–î–†–ï–°–ê === */
function clearAddress() {
  const addressInput = document.getElementById('address');
  addressInput.value = '';
  addressInput.classList.remove('valid', 'invalid');
  selectedAddressData = null;
  document.getElementById('clearAddressBtn').classList.add('hidden');
  addressInput.focus();
}

/* === –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –¢–ï–õ–ï–§–û–ù–ê –ü–†–ò –í–í–û–î–ï (–ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï) === */
function formatPhoneInput() {
  const phoneInput = document.getElementById('phone');
  let value = phoneInput.value.replace(/\D/g, '');
  
  if (value.length === 0) {
    phoneInput.value = '';
    return;
  }
  
  // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 8, –º–µ–Ω—è–µ–º –Ω–∞ +7
  if (value[0] === '8') {
    value = '7' + value.substring(1);
  }
  
  // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 9, –¥–æ–±–∞–≤–ª—è–µ–º 7 –≤ –Ω–∞—á–∞–ª–æ
  if (value[0] === '9' && value.length <= 10) {
    value = '7' + value;
  }
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ +7 (XXX) XXX-XX-XX
  let formatted = '+7';
  
  if (value.length > 1) {
    formatted += ' (' + value.substring(1, 4);
  }
  
  if (value.length >= 4) {
    formatted += ') ' + value.substring(4, 7);
  }
  
  if (value.length >= 7) {
    formatted += '-' + value.substring(7, 9);
  }
  
  if (value.length >= 9) {
    formatted += '-' + value.substring(9, 11);
  }
  
  phoneInput.value = formatted;
}

/* === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–õ–ò–ß–ï–°–¢–í–û–ú –¢–û–í–ê–†–û–í === */
function changeQuantity(productId, delta) {
  const productList = currentTab === "halal" ? halalProducts : normalProducts;
  const product = productList.find(p => p.id === productId);
  
  const index = cart.findIndex(item => item.id === productId);
  let currentKg = 0;
  
  if (index !== -1) {
    currentKg = cart[index].kg;
  }
  
  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º/—É–º–µ–Ω—å—à–∞–µ–º –Ω–∞ 5 –∫–≥
  let newKg = Math.max(0, currentKg + delta);
  
  // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –∫—Ä–∞—Ç–Ω–æ–≥–æ 5
  newKg = Math.round(newKg / 5) * 5;
  
  if (newKg > 0) {
    if (index !== -1) {
      cart[index].kg = newKg;
    } else {
      cart.push({
        ...product,
        kg: newKg,
        type: currentTab
      });
    }
  } else if (index !== -1) {
    cart.splice(index, 1);
  }
  
  renderProducts();
  calcTotal();
  saveCartToLocalStorage();
}

function renderProducts() {
  const productsContainer = document.getElementById('products');
  const list = currentTab === "halal" ? halalProducts : normalProducts;
  
  // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –¥–≤–∞ —Å—Ç–æ–ª–±—Ü–∞: 6 –∏ 5 —Ç–æ–≤–∞—Ä–æ–≤
  const column1 = list.slice(0, 6);
  const column2 = list.slice(6);
  
  productsContainer.innerHTML = '';
  
  // –ü–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü
  column1.forEach(product => {
    const existing = cart.find(item => item.id === product.id);
    const quantity = existing ? existing.kg : 0;
    
    const productCard = document.createElement('div');
    productCard.className = 'product-card';
    productCard.innerHTML = `
      <div class="product-header">
        <span class="product-emoji">${product.emoji}</span>
        <div class="product-name">${product.name}</div>
      </div>
      <div class="product-price">${product.price} ‚ÇΩ/–∫–≥</div>
      <div class="product-controls">
        <div class="quantity-display">
          ${quantity}<span class="kg-label">–∫–≥</span>
        </div>
        <div class="quantity-buttons">
          <button class="quantity-btn minus" onclick="changeQuantity(${product.id}, -5)">‚àí5</button>
          <button class="quantity-btn plus" onclick="changeQuantity(${product.id}, 5)">+5</button>
        </div>
      </div>
    `;
    productsContainer.appendChild(productCard);
  });
  
  // –í—Ç–æ—Ä–æ–π —Å—Ç–æ–ª–±–µ—Ü
  column2.forEach(product => {
    const existing = cart.find(item => item.id === product.id);
    const quantity = existing ? existing.kg : 0;
    
    const productCard = document.createElement('div');
    productCard.className = 'product-card';
    productCard.innerHTML = `
      <div class="product-header">
        <span class="product-emoji">${product.emoji}</span>
        <div class="product-name">${product.name}</div>
      </div>
      <div class="product-price">${product.price} ‚ÇΩ/–∫–≥</div>
      <div class="product-controls">
        <div class="quantity-display">
          ${quantity}<span class="kg-label">–∫–≥</span>
        </div>
        <div class="quantity-buttons">
          <button class="quantity-btn minus" onclick="changeQuantity(${product.id}, -5)">‚àí5</button>
          <button class="quantity-btn plus" onclick="changeQuantity(${product.id}, 5)">+5</button>
        </div>
      </div>
    `;
    productsContainer.appendChild(productCard);
  });
}

function calcTotal() {
  let cashSum = 0;
  let cashlessSum = 0;
  
  cart.forEach(item => {
    if (item.kg > 0) {
      cashSum += item.kg * item.price;
      cashlessSum += item.kg * (item.price + 10);
    }
  });
  
  document.getElementById('total').textContent = cashSum.toLocaleString('ru-RU');
  
  const cashlessElement = document.getElementById('cashlessTotal');
  if (cashlessSum > cashSum) {
    cashlessElement.textContent = `–ü—Ä–∏ –±–µ–∑–Ω–∞–ª–∏—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ: ${cashlessSum.toLocaleString('ru-RU')} ‚ÇΩ`;
    cashlessElement.style.display = 'block';
  } else {
    cashlessElement.style.display = 'none';
  }
}

/* === –ö–ê–õ–ï–ù–î–ê–†–¨ –¢–û–õ–¨–ö–û –ù–ê –¢–ï–ö–£–©–£–Æ –ù–ï–î–ï–õ–Æ === */
let currentCalendarDate = new Date();
currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
const today = new Date();
today.setHours(0, 0, 0, 0);

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏ (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
function getWeekEndDate() {
  const endOfWeek = new Date(today);
  const dayOfWeek = endOfWeek.getDay();
  const daysToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
  endOfWeek.setDate(endOfWeek.getDate() + daysToSunday);
  return endOfWeek;
}

const maxDate = getWeekEndDate();

function formatDate(date) {
  const options = { weekday: 'long', day: 'numeric', month: 'long' };
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);
  
  if (date.toDateString() === today.toDateString()) return '–°–µ–≥–æ–¥–Ω—è';
  if (date.toDateString() === tomorrow.toDateString()) return '–ó–∞–≤—Ç—Ä–∞';
  
  return date.toLocaleDateString('ru-RU', options);
}

function updateSelectedDateDisplay() {
  document.getElementById('selectedDate').textContent = formatDate(currentCalendarDate);
}

function openCalendar() {
  renderCalendar();
  document.getElementById('calendarPopup').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeCalendar() {
  document.getElementById('calendarPopup').classList.add('hidden');
  document.body.style.overflow = 'auto';
  updateSelectedDateDisplay();
}

function renderCalendar() {
  const year = today.getFullYear();
  const month = today.getMonth();
  
  const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                     '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
  document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
  
  document.getElementById('prevMonthBtn').style.visibility = 'hidden';
  document.getElementById('nextMonthBtn').style.visibility = 'hidden';
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  
  const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
  let calendarHTML = '';
  
  dayNames.forEach(day => {
    calendarHTML += `<div class="calendar-day">${day}</div>`;
  });
  
  const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
  for (let i = 0; i < startDay; i++) {
    calendarHTML += `<div class="calendar-date"></div>`;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    date.setHours(0, 0, 0, 0);
    
    const isToday = date.getTime() === today.getTime();
    const isSelected = date.getTime() === currentCalendarDate.getTime();
    const isDisabled = date < today || date > maxDate;
    
    let className = 'calendar-date';
    if (isToday) className += ' calendar-today';
    if (isSelected) className += ' selected';
    if (isDisabled) className += ' disabled';
    
    calendarHTML += `
      <div class="${className}" 
           ${!isDisabled ? `onclick="selectDate(${year}, ${month}, ${day})"` : ''}>
        ${day}
      </div>
    `;
  }
  
  document.getElementById('calendarGrid').innerHTML = calendarHTML;
}

function selectDate(year, month, day) {
  currentCalendarDate = new Date(year, month, day);
  currentCalendarDate.setHours(0, 0, 0, 0);
  closeCalendar();
}

/* === –ê–í–¢–û–î–û–ü–û–õ–ù–ï–ù–ò–ï –ê–î–†–ï–°–ê === */
const addressInput = document.getElementById('address');
const addressList = document.getElementById('addressList');

// –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å/—Å–∫—Ä—ã–≤–∞—Ç—å –∫—Ä–µ—Å—Ç–∏–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
addressInput.addEventListener('input', function() {
  const clearBtn = document.getElementById('clearAddressBtn');
  if (this.value.trim().length > 0) {
    clearBtn.classList.remove('hidden');
  } else {
    clearBtn.classList.add('hidden');
    this.classList.remove('valid', 'invalid');
    selectedAddressData = null;
  }
});

addressInput.addEventListener('input', function() {
  clearTimeout(addressTimeout);
  const query = this.value.trim();
  
  if (query.length < 2) {
    addressList.classList.add('hidden');
    return;
  }
  
  addressList.innerHTML = '<div class="autocomplete-item">–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤...</div>';
  addressList.classList.remove('hidden');
  
  addressTimeout = setTimeout(() => searchAddresses(query), 300);
});

async function searchAddresses(query) {
  try {
    const url = `https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address`;
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Authorization': `Token ${DADATA_API_KEY}`
      },
      body: JSON.stringify({
        query: query,
        count: 7,
        locations: [
          { 
            region: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
            region_type_full: '–≥–æ—Ä–æ–¥'
          },
          { 
            region: '–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è',
            region_type_full: '–æ–±–ª–∞—Å—Ç—å'
          }
        ],
        from_bound: { value: "street" },
        to_bound: { value: "house" },
        restrict_value: true,
        language: "ru"
      })
    });
    
    if (!response.ok) {
      console.error('–û—à–∏–±–∫–∞ DaData:', await response.text());
      throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ DaData');
    }
    
    const data = await response.json();
    
    if (!data.suggestions || data.suggestions.length === 0) {
      addressList.innerHTML = '<div class="autocomplete-empty">–ê–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –£—Ç–æ—á–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å</div>';
      return;
    }
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≥–æ—Ä–æ–¥–∞
    addressList.innerHTML = data.suggestions.map((item, index) => {
      const data = item.data;
      let mainText = '';
      let details = '';
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç: —É–ª–∏—Ü–∞ –∏ –¥–æ–º
      if (data.street) {
        mainText = data.street;
        if (data.house) {
          mainText += `, ${data.house}`;
        }
      } else if (data.house) {
        mainText = data.house;
      } else {
        mainText = item.value;
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä–æ–¥/–Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç
      const locationInfo = [];
      
      if (data.city) {
        locationInfo.push(data.city);
      } else if (data.settlement) {
        locationInfo.push(data.settlement);
      } else if (data.area) {
        locationInfo.push(data.area);
      }
      
      if (data.region) {
        const regionType = data.region_type_full === '–≥–æ—Ä–æ–¥' ? '–≥.' : '–æ–±–ª.';
        locationInfo.push(`${regionType} ${data.region}`);
      }
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏: –∫–æ—Ä–ø—É—Å, —Å—Ç—Ä–æ–µ–Ω–∏–µ, —Ä–∞–π–æ–Ω
      const detailsParts = locationInfo;
      if (data.block_type && data.block) {
        detailsParts.push(`${data.block_type} ${data.block}`);
      }
      
      details = detailsParts.join(', ');
      
      return `
        <div class="autocomplete-item" data-address="${item.value}" data-index="${index}">
          <b>${mainText}</b>
          <span class="address-details">${details}</span>
        </div>
      `;
    }).join('');
    
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
    addressList.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', function() {
        const index = this.getAttribute('data-index');
        const selectedSuggestion = data.suggestions[index];
        
        addressInput.value = selectedSuggestion.value;
        selectedAddressData = selectedSuggestion.data;
        addressList.classList.add('hidden');
        addressInput.classList.remove('invalid');
        addressInput.classList.add('valid');
        showNotification('–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω', 'success');
      });
    });
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–∞:', error);
    addressList.innerHTML = '<div class="autocomplete-empty">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç</div>';
  }
}

// –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', function(e) {
  if (!addressInput.contains(e.target) && !addressList.contains(e.target)) {
    addressList.classList.add('hidden');
  }
});

/* === –ü–†–û–í–ï–†–ö–ê –ê–î–†–ï–°–ê –° –ü–û–ú–û–©–¨–Æ DaData === */
async function validateAddress(address) {
  if (!address || address.trim().length < 5) {
    return { isValid: false, message: '–ê–¥—Ä–µ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π' };
  }
  
  try {
    const url = `https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address`;
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'Authorization': `Token ${DADATA_API_KEY}`
      },
      body: JSON.stringify({
        query: address,
        count: 5,
        locations: [
          { 
            region: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥',
            region_type_full: '–≥–æ—Ä–æ–¥'
          },
          { 
            region: '–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è',
            region_type_full: '–æ–±–ª–∞—Å—Ç—å'
          }
        ],
        restrict_value: true,
        language: "ru"
      })
    });
    
    if (!response.ok) {
      return { isValid: false, message: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥—Ä–µ—Å–∞' };
    }
    
    const data = await response.json();
    
    // –ï—Å–ª–∏ DaData –Ω–∞—à–ª–∞ —Ç–æ—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
    if (data.suggestions && data.suggestions.length > 0) {
      const suggestion = data.suggestions[0];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –∞–¥—Ä–µ—Å (–∞ –Ω–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∏ —Ç.–¥.)
      if (suggestion.data.street || suggestion.data.house) {
        selectedAddressData = suggestion.data;
        return { 
          isValid: true, 
          message: '–ê–¥—Ä–µ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
          data: suggestion.data,
          value: suggestion.value
        };
      }
    }
    
    return { isValid: false, message: '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ –∏–ª–∏ –õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏' };
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥—Ä–µ—Å–∞:', error);
    return { isValid: false, message: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–∏—Å–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥—Ä–µ—Å–æ–≤' };
  }
}


/* === –ü–û–ö–ê–ó–ê–¢–¨ –ü–û–î–°–ö–ê–ó–ö–ò –ê–î–†–ï–°–û–í === */
function showAddressSuggestions(suggestions) {
  addressList.innerHTML = suggestions.map((item, index) => {
    const data = item.data;
    let mainText = '';
    let details = '';
    
    if (data.street) {
      mainText = data.street;
      if (data.house) {
        mainText += `, ${data.house}`;
      }
    } else if (data.house) {
      mainText = data.house;
    } else {
      mainText = item.value;
    }
    
    const locationInfo = [];
    if (data.city) locationInfo.push(data.city);
    else if (data.settlement) locationInfo.push(data.settlement);
    if (data.region) locationInfo.push(`${data.region_type_full} ${data.region}`);
    
    details = locationInfo.join(', ');
    
    return `
      <div class="autocomplete-item" data-address="${item.value}" data-index="${index}">
        <b>${mainText}</b>
        <span class="address-details">${details}</span>
      </div>
    `;
  }).join('');
  
  addressList.classList.remove('hidden');
  
  // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞
  addressList.querySelectorAll('.autocomplete-item').forEach(item => {
    item.addEventListener('click', function() {
      const index = this.getAttribute('data-index');
      const selectedSuggestion = suggestions[index];
      
      addressInput.value = selectedSuggestion.value;
      selectedAddressData = selectedSuggestion.data;
      addressList.classList.add('hidden');
      addressInput.classList.remove('invalid');
      addressInput.classList.add('valid');
      showNotification('–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω', 'success');
    });
  });
}

/* === –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô === */
function updateCommentCounter() {
  const comment = document.getElementById('comment');
  const counter = document.getElementById('commentCounter');
  const length = comment.value.length;
  counter.textContent = `${length}/500 —Å–∏–º–≤–æ–ª–æ–≤`;
  
  if (length > 450) {
    counter.style.color = '#ff3b30';
  } else if (length > 400) {
    counter.style.color = '#ff9500';
  } else {
    counter.style.color = '#666';
  }
}

/* === –í–ê–õ–ò–î–ê–¶–ò–Ø –¢–ï–õ–ï–§–û–ù–ê === */
function validatePhone(phone) {
  const cleanPhone = phone.replace(/\D/g, '');
  
  // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 11 —Ü–∏—Ñ—Ä (7XXXXXXXXXX)
  if (cleanPhone.length !== 11) return false;
  
  // –î–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 7
  if (cleanPhone[0] !== '7') return false;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç +7 (XXX) XXX-XX-XX
  const phoneRegex = /^\+7\s\(\d{3}\)\s\d{3}-\d{2}-\d{2}$/;
  return phoneRegex.test(phone);
}

/* === –ü–û–í–¢–û–† –ü–†–ï–î–´–î–£–©–ï–ì–û –ó–ê–ö–ê–ó–ê === */
function repeatLastOrder() {
  if (!lastOrderData || !lastOrderData.cart || lastOrderData.cart.length === 0) {
    showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∑–∞–∫–∞–∑–µ', 'error');
    return;
  }
  
  // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ—Ä–∑–∏–Ω—É
  cart.length = 0;
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞
  lastOrderData.cart.forEach(item => {
    if (item.kg > 0) {
      cart.push({
        ...item,
        type: currentTab
      });
    }
  });
  
  renderProducts();
  calcTotal();
  showNotification('–ü—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–∫–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É', 'success');
}

/* === –û–ë–©–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–î–°–í–ï–¢–ö–û–ô –ü–û–õ–ï–ô === */
function setupFieldValidation(fieldId) {
  const field = document.getElementById(fieldId);
  
  if (!field) return;
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ (—É–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –≤–≤–æ–¥–∞)
  field.addEventListener('input', function() {
    if (this.value.trim() === '') {
      this.classList.remove('valid', 'invalid');
    } else {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç –≤–≤–æ–¥–∏—Ç—å –∑–∞–Ω–æ–≤–æ, —É–±–∏—Ä–∞–µ–º –∑–µ–ª–µ–Ω—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
      this.classList.remove('valid');
    }
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ–∫—É—Å–∞ (—É–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
  field.addEventListener('focus', function() {
    this.classList.remove('valid');
  });
}

/* === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–ê–õ–ò–î–ê–¶–ò–ò –ü–û–õ–ï–ô === */
function initializeFieldValidations() {
  // –í—Å–µ –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è
  const fieldsToValidate = ['firstName', 'lastName', 'phone', 'organizationName', 'address'];
  
  fieldsToValidate.forEach(fieldId => {
    setupFieldValidation(fieldId);
  });
  
  // –î–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  const phoneInput = document.getElementById('phone');
  phoneInput.addEventListener('focus', function() {
    // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ —É–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥—Å–≤–µ—Ç–∫—É, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
    this.classList.remove('valid');
  });
  
  phoneInput.addEventListener('input', function() {
    if (this.value.trim() === '') {
      this.classList.remove('valid', 'invalid');
    }
    formatPhoneInput();
  });
}

/* === –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• === */
function saveCartToLocalStorage() {
  const userData = {
    firstName: document.getElementById('firstName')?.value || '',
    lastName: document.getElementById('lastName')?.value || '',
    phone: document.getElementById('phone')?.value || '',
    organizationName: document.getElementById('organizationName')?.value || '',
    address: document.getElementById('address')?.value || '',
    cart: [...cart]
  };
  localStorage.setItem('meatShopFullData', JSON.stringify(userData));
}

function loadLastOrderFromStorage() {
  const savedData = localStorage.getItem('meatShopFullData');
  if (savedData) {
    try {
      const data = JSON.parse(savedData);
      lastOrderData = data;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–∞ –∑–∞–∫–∞–∑–∞ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞
      const repeatBtn = document.getElementById('repeatOrderBtn');
      if (data.cart && data.cart.length > 0) {
        repeatBtn.style.display = 'block';
      } else {
        repeatBtn.style.display = 'none';
      }
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e);
    }
  }
}

/* === –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø === */
function validateAndOpenShop() {
  const firstName = document.getElementById('firstName');
  const phone = document.getElementById('phone');
  const organizationName = document.getElementById('organizationName');
  
  firstName.classList.remove('invalid', 'valid');
  phone.classList.remove('invalid', 'valid');
  organizationName.classList.remove('invalid', 'valid');
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏
  if (!firstName.value.trim()) {
    firstName.classList.add('invalid');
    showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º—è', 'error');
    firstName.focus();
    return;
  } else {
    firstName.classList.add('valid');
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  const phoneValue = phone.value.trim();
  if (!phoneValue) {
    phone.classList.add('invalid');
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
    phone.focus();
    return;
  }
  
  if (!validatePhone(phoneValue)) {
    phone.classList.add('invalid');
    showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 (XXX) XXX-XX-XX', 'error');
    phone.focus();
    return;
  } else {
    phone.classList.add('valid');
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
  if (!organizationName.value.trim()) {
    organizationName.classList.add('invalid');
    showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞/—Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞', 'error');
    organizationName.focus();
    return;
  } else {
    organizationName.classList.add('valid');
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
  window.userData = {
    firstName: firstName.value.trim(),
    lastName: document.getElementById('lastName').value.trim(),
    phone: phoneValue,
    organizationName: organizationName.value.trim()
  };
  
  openShop();
}

function openShop() {
  document.getElementById('regBlock').classList.add('hidden');
  document.getElementById('shopBlock').classList.remove('hidden');
  switchTab('halal');
  showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã', 'success');
  updateSelectedDateDisplay();
  updateCommentCounter();
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
  loadLastOrderFromStorage();
}

function switchTab(tab) {
  currentTab = tab;
  const tabHalal = document.getElementById('tabHalal');
  const tabNormal = document.getElementById('tabNormal');
  
  tabHalal.classList.toggle('active', tab === "halal");
  tabNormal.classList.toggle('active', tab === "normal");
  
  renderProducts();
}

/* === –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê === */
async function openReceiptModal() {
  const address = addressInput.value.trim();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞
  if (!address) {
    showNotification('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏', 'error');
    addressInput.focus();
    addressInput.classList.add('invalid');
    return;
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥—Ä–µ—Å–∞
  showNotification('–ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥—Ä–µ—Å...', 'info');
  
  // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å —á–µ—Ä–µ–∑ DaData
  const validationResult = await validateAddress(address);
  
  if (!validationResult.isValid) {
    if (validationResult.suggestions) {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      showAddressSuggestions(validationResult.suggestions);
      return;
    }
    
    showNotification(validationResult.message, 'error');
    addressInput.focus();
    addressInput.classList.add('invalid');
    return;
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –∞–¥—Ä–µ—Å–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
  addressInput.value = validationResult.value;
  addressInput.classList.remove('invalid');
  addressInput.classList.add('valid');
  selectedAddressData = validationResult.data;
  
  const activeCart = cart.filter(item => item.kg > 0);
  if (activeCart.length === 0) {
    showNotification('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É', 'error');
    return;
  }
  
  const receiptContent = document.getElementById('receiptContent');
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—ã
  let cashTotal = 0;
  let cashlessTotal = 0;
  activeCart.forEach(item => {
    cashTotal += item.kg * item.price;
    cashlessTotal += item.kg * (item.price + 10);
  });
  
  let html = `
    <div style="margin-bottom:20px;">
      <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${window.userData.firstName} ${window.userData.lastName}</p>
      <p><strong>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è:</strong> ${window.userData.organizationName}</p>
      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${window.userData.phone}</p>
      <p><strong>–ê–¥—Ä–µ—Å:</strong> ${addressInput.value}</p>
      <p><strong>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> ${formatDate(currentCalendarDate)}</p>
  `;
  
  const comment = document.getElementById('comment').value.trim();
  if (comment) {
    html += `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${comment}</p>`;
  }
  
  html += `</div>
    <hr style="border:none;border-top:1px solid #eee;margin:20px 0;">
    <div style="max-height:300px;overflow-y:auto;">
      <h4 style="margin-top:0;">–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:</h4>
  `;
  
  activeCart.forEach(item => {
    const itemCash = item.kg * item.price;
    const itemCashless = item.kg * (item.price + 10);
    
    html += `
      <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f5f5f5;">
        <div>
          <strong>${item.name}</strong><br>
          <small>${item.type === 'halal' ? 'ü•© –•–∞–ª—è–ª—å' : 'üçó –û–±—ã—á–Ω–æ–µ'}</small>
        </div>
        <div style="text-align:right;">
          ${item.kg} –∫–≥ √ó ${item.price} ‚ÇΩ<br>
          <strong>${itemCash.toLocaleString('ru-RU')} ‚ÇΩ</strong>
          ${itemCashless > itemCash ? 
            `<div style="font-size:12px;color:#ff9500;">–ë–µ–∑–Ω–∞–ª: ${itemCashless.toLocaleString('ru-RU')} ‚ÇΩ</div>` 
            : ''}
        </div>
      </div>
    `;
  });
  
  html += `
    </div>
    <hr style="border:none;border-top:1px solid #eee;margin:20px 0;">
    <div style="text-align:center;margin-bottom:15px;padding:10px;background:#f8f9fa;border-radius:10px;">
      üí∞ <strong>–¶–µ–Ω—ã —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –Ω–∞–ª–∏—á–Ω—ã–º–∏</strong><br>
      –ü—Ä–∏ –±–µ–∑–Ω–∞–ª–∏—á–Ω–æ–π –æ–ø–ª–∞—Ç–µ –∫–∞–∂–¥–∞—è –ø–æ–∑–∏—Ü–∏—è —Å—Ç–æ–∏—Ç –Ω–∞ 10 —Ä—É–±–ª–µ–π –¥–æ—Ä–æ–∂–µ
    </div>
    <div style="text-align:right;">
      <div style="font-size:20px;font-weight:bold;color:#2ea6ff;">
        –ù–∞–ª–∏—á–Ω—ã–µ: ${cashTotal.toLocaleString('ru-RU')} ‚ÇΩ
      </div>
      <div style="font-size:18px;color:#ff9500;margin-top:5px;">
        –ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã–µ: ${cashlessTotal.toLocaleString('ru-RU')} ‚ÇΩ
      </div>
    </div>
  `;
  
  receiptContent.innerHTML = html;
  document.getElementById('receiptModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeReceiptModal() {
  document.getElementById('receiptModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function sendOrder() {
    const activeCart = cart.filter(item => item.kg > 0);
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—É–º–º—ã
    let cashTotal = 0;
    let cashlessTotal = 0;
    activeCart.forEach(item => {
      cashTotal += item.kg * item.price;
      cashlessTotal += item.kg * (item.price + 10);
    });
    
    const orderData = {
        user: window.userData,
        cart: activeCart,
        address: addressInput.value.trim(),
        addressData: selectedAddressData,
        date: currentCalendarDate.toISOString().split('T')[0],
        dateFormatted: formatDate(currentCalendarDate),
        comment: document.getElementById('comment').value.trim(),
        cashTotal: cashTotal,
        cashlessTotal: cashlessTotal,
        total: cashTotal
    };
    
    console.log('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:', orderData);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ –∫–∞–∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–π
    lastOrderData = orderData;
    saveCartToLocalStorage();
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Telegram WebApp
    if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.sendData(JSON.stringify(orderData));
    } else {
        console.error('Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞', 'error');
        return;
    }
    
    showNotification('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!', 'success');
    
    setTimeout(() => {
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.close();
        }
    }, 2000);
}

function backToRegistration() {
  document.getElementById('shopBlock').classList.add('hidden');
  document.getElementById('regBlock').classList.remove('hidden');
}

function showNotification(message, type = 'info') {
  const notification = document.getElementById('notification');
  notification.textContent = message;
  notification.className = 'notification';
  notification.style.background = type === 'error' ? '#ff3b30' : 
                                 type === 'success' ? '#4cd964' : '#2ea6ff';
  notification.classList.remove('hidden');
  
  setTimeout(() => {
    notification.classList.add('hidden');
  }, 3000);
}

/* === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø === */
document.addEventListener('DOMContentLoaded', function() {
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  const savedData = localStorage.getItem('meatShopFullData');
  if (savedData) {
    try {
      const data = JSON.parse(savedData);
      document.getElementById('firstName').value = data.firstName || '';
      document.getElementById('lastName').value = data.lastName || '';
      document.getElementById('phone').value = data.phone || '';
      document.getElementById('organizationName').value = data.organizationName || '';
      document.getElementById('address').value = data.address || '';
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑
      lastOrderData = data;
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e);
    }
  }
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  const phoneInput = document.getElementById('phone');
  phoneInput.addEventListener('input', formatPhoneInput);
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
  phoneInput.addEventListener('blur', function() {
    if (this.value.trim() && !validatePhone(this.value)) {
      this.classList.add('invalid');
      showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 (XXX) XXX-XX-XX', 'error');
    } else if (this.value.trim()) {
      this.classList.remove('invalid');
      this.classList.add('valid');
    }
  });
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  ['firstName', 'lastName', 'phone', 'organizationName'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('blur', function() {
        const userData = {
          firstName: document.getElementById('firstName').value,
          lastName: document.getElementById('lastName').value,
          phone: document.getElementById('phone').value,
          organizationName: document.getElementById('organizationName').value,
          address: document.getElementById('address').value,
          cart: cart
        };
        localStorage.setItem('meatShopFullData', JSON.stringify(userData));
      });
    }
  });
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
  addressInput.addEventListener('blur', async function() {
    const address = this.value.trim();
    if (address && address.length > 5) {
      const validationResult = await validateAddress(address);
      if (validationResult.isValid) {
        this.value = validationResult.value;
        this.classList.remove('invalid');
        this.classList.add('valid');
        selectedAddressData = validationResult.data;
        showNotification('–ê–¥—Ä–µ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω', 'success');
      } else {
        this.classList.add('invalid');
      }
    }
  });
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ–ª–µ–π
  initializeFieldValidations();
  
  calcTotal();
  updateSelectedDateDisplay();
  renderProducts();
  updateCommentCounter();
});
</script>
</body>

</html>
